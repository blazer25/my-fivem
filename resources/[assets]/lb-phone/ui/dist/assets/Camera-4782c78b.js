import{u as b,r,v as o,aW as ye,a2 as V,A as T,aX as O,P as A,az as ee,t as l,b as te,C as K,a as n,F as ae,j as g,aY as be,aZ as Ae,a_ as Se,a$ as ke,X as Ie,Q as Re,m as se,b0 as Pe,L as ne,w as S,b1 as Ne,b2 as Oe,a6 as Ee,x as we,ab as Le,b3 as $e,V as Fe}from"./index-569b241b.js";function xe(){var J;const U=b(te),Z=b(O.Unlocked),re=b(O.PassedFaceId),C=b(O.Visible),[E,y]=r.useState(!1),[c,w]=r.useState("Photo"),[k,D]=r.useState(!1),[ie,z]=r.useState(!1),[G,I]=r.useState(null),[h,X]=r.useState(!1),[j,oe]=r.useState(!1),[m,L]=r.useState(!1),[ce,Q]=r.useState(0),[R,le]=r.useState([.5,1,2,5]),[B,H]=r.useState(1),[ue,de]=r.useState(1),me=!R.includes(B),[fe,$]=r.useState({}),u=b(Fe),d=b(T),F=r.useRef(null),M=r.useRef(null),P=r.useRef(null),i=r.useRef(null),v=r.useRef(!1),f=["Video","Photo","Landscape"],W=()=>{c==="Photo"&&h&&!U.CustomCamera?i.current.setXOffset(-.2):h&&U.CustomCamera?i.current.setXOffset(.1):i.current.setXOffset(0)},ge=()=>{if(o("info","Camera app is active & open, initializing game render & audio stream"),l("Camera",{action:"open"}),i.current&&i.current.resume(),l("Camera",{action:"flipCamera",value:h},"OK"),S.APPS.CAMERA.lastImage.value)return x(S.APPS.CAMERA.lastImage.value);l("Camera",{action:"getLastImage"},Oe.Photos[0].src).then(e=>{e&&x(e)})},he=()=>{var e;o("info","Camera app is not active or open, pausing game render & releasing audio stream"),l("Camera",{action:"close"}),m&&L(!1),i.current&&((e=i.current)==null||e.pause())};r.useEffect(()=>{var a,t;const e=!(u!=null&&u.visible)&&((a=d==null?void 0:d.active)==null?void 0:a.name)==="Camera"&&C;v.current!==e&&(v.current=e,o("info","Camera app active:",e,u==null?void 0:u.visible,(t=d==null?void 0:d.active)==null?void 0:t.name,C),e?ge():he())},[u==null?void 0:u.visible,(J=d==null?void 0:d.active)==null?void 0:J.name,i.current,C]),r.useEffect(()=>{P.current&&v.current&&(i.current||(o("info","Initializing game render"),i.current=new ye(P.current)))},[P.current]),r.useEffect(()=>()=>{o("info","Cleaning up camera app"),i.current&&(o("info","Destroying game render"),i.current.destroy(),i.current=null)},[]),V("camera:setZoom",e=>{H(e);let a=R.reduce((t,s)=>s<=e&&s>t?s:t,0);de(a)}),V("camera:setZoomLevels",e=>le(e)),V("camera:usedCommand",e=>{var a;if(u!=null&&u.visible||((a=d==null?void 0:d.active)==null?void 0:a.name)!=="Camera"||!C)return o("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":Y();break;case"toggleFlip":X(t=>!t);break;case"toggleFlash":D(t=>!t);break;case"leftMode":if(m)return;w(t=>{const s=f.indexOf(t);return s===0?f[f.length-1]:f[s-1]});break;case"rightMode":if(m)return;w(t=>{const s=f.indexOf(t);return s===f.length-1?f[0]:f[s+1]});break}}),r.useEffect(()=>{if(!M.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),M.current.innerText=ne("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[E]);const x=(e,a)=>{if(a===void 0&&(a=Ee(e)),a){const t=document.createElement("video");t.src=e,t.muted=!0,t.play().catch(()=>{});const s=document.createElement("canvas");if(!s)return;t.addEventListener("loadeddata",()=>{s.width=t.videoWidth,s.height=t.videoHeight,s.getContext("2d").drawImage(t,0,0,s.width,s.height);const p=s.toDataURL("image/png");F.current.style.backgroundImage=`url(${p})`,S.APPS.CAMERA.lastImage.set(p),s.remove(),t.remove()})}else F.current.style.backgroundImage=`url(${e})`,S.APPS.CAMERA.lastImage.set(e)};r.useEffect(()=>{if(!C)return()=>{T.patch({active:null}),Z||O.LockScreenVisible.set(!0)}},[C]),r.useEffect(()=>{var a,t;if(m||!i.current||!v.current)return;switch(c){case"Landscape":if((a=ee)!=null&&a.value)return;$({marginRight:"9rem"}),A.Styles.Rotation.set(90);break;case"Video":A.Styles.Rotation.set(0),$({marginLeft:"12rem"});break;default:A.Styles.Rotation.set(0),$({marginLeft:"3rem"});break}if(c==="Landscape"){if((t=ee)!=null&&t.value)return;i.current.resizeByAspect(16/9)}else(c==="Video"||c==="Photo")&&i.current.resizeByAspect(3/4);l("Camera",{action:"toggleLandscape",toggled:c==="Landscape"},"OK"),l("Camera",{action:"toggleVideo",toggled:c==="Video"},"OK");const e=window.innerWidth;e>1920&&i.current.setQuality(1920/e),W()},[c,v.current]),r.useEffect(()=>{if(!v.current)return o("info","camera app is not active, not triggering flipCamera");l("Camera",{action:"flipCamera",value:h},"OK"),W()},[h]);const _=r.useRef(!0),q=async(e,a)=>{const t=we(e.size/1e3,2);k&&l("toggleFlashlight",{toggled:!1},"OK");try{const s=await Le(a?"Video":"Image",e);if(!s)throw new Error("Failed to upload media (URL is null)");return x(s),o("info",`Saving ${a?"video":"photo"} to gallery (${t}kb) - ${s}, args(${s}, ${t}, ${h&&!a?"selfie":null})`),await $e(s,t,h&&!a?"selfie":null,!0),!0}catch(s){throw s}};r.useEffect(()=>{if(_.current){_.current=!1;return}if(k&&!m&&l("toggleFlashlight",{toggled:!1},"OK"),!m)return;const e=i.current.startRecording(async t=>{if(m&&L(!1),!v.current)return o("info","camera app is not active, not saving video");y(!0);try{await q(t,!0),o("info","Video uploaded successfully"),y(!1)}catch(s){o("error","Could not upload video",s),y(!1),I(s.message),await new Promise(p=>setTimeout(p,1e4)),I(null)}}),a=setInterval(()=>{Q(t=>t+1)},1e3);return()=>{Q(0),clearInterval(a),e&&e.state==="recording"&&e.stop()}},[m]);const ve=e=>{let a=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+a},pe=e=>{l("Camera",{action:"setQuickZoom",value:e},"OK").then(()=>{H(e)})},Y=async()=>{var a,t,s,p;if(E)return o("info","Returning since an image is currently uploading");if(k&&await l("toggleFlashlight",{toggled:!0},"OK"),c=="Video"){await l("Camera",{action:"toggleHud",toggled:m},"OK"),L(N=>!N);return}(t=(a=A.Settings.value)==null?void 0:a.sound)!=null&&t.silent||(((p=(s=te.value)==null?void 0:s.sound)==null?void 0:p.system)==="nui"?A.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}):l("playSound",{soundType:"cameraShutter"},"ok")),z(!0),K.IndicatorVisible.set(!1),y(!0),o("info","Uploading image, converting to blob");const e=await i.current.takePhoto();try{await q(e,!1),o("info","Image uploaded successfully"),y(!1),K.IndicatorVisible.set(!0)}catch(N){o("error","Could not upload image",N),y(!1),I(N.message),K.IndicatorVisible.set(!0),await new Promise(Ce=>setTimeout(Ce,1e4)),I(null)}z(!1)};return n(ae,{children:g("div",{className:"camera-container",children:[g("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>D(e=>!e),children:!m&&k?n(be,{}):n(Ae,{})}),c==="Video"&&n(ae,{children:n("div",{className:"timer",children:ve(ce)})}),n("div",{className:"grid-toggle",onClick:()=>oe(e=>!e),children:j?n(Se,{}):n(ke,{})})]}),g("div",{className:Ie("camera-body",c=="Landscape"&&"rotate"),children:[n("canvas",{ref:P,style:{visibility:ie?"hidden":"visible"}}),n(Re,{children:j&&n(se.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.1,ease:"easeInOut"},className:"grid",children:Array.from({length:9}).map((e,a)=>n("div",{className:"grid-item"},a))})}),R.length>0&&n("div",{className:"quick-zoom",children:R.map(e=>{let a=ue===e;return g(se.div,{animate:{width:a?"1.75rem":"1.35rem",height:a?"1.75rem":"1.35rem"},transition:{duration:.2,ease:"easeInOut"},className:"item","data-active":a,onClick:()=>pe(e),children:[a&&me?B:e,a&&n("span",{children:"x"})]},`${a}-${e}`)})}),E&&g("div",{className:"camera-loading",children:[n(Pe,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:M,children:"Uploading..."})]}),G&&n("div",{className:"camera-loading",children:g("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),G]})})]}),g("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:fe,children:f.map((e,a)=>n("div",{className:`${c===e&&"active"}`,onClick:()=>w(e),children:ne(`APPS.CAMERA.${e.toUpperCase()}`)},a))}),g("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:F,onClick:()=>{!re&&!Z||(l("Camera",{action:"close"},"OK"),A.Styles.Rotation.set(0),T.patch({active:{name:"Photos",data:{photo:S.APPS.CAMERA.lastImage.value}}}))}}),n("div",{className:"camera-button",onClick:()=>Y(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${c=="Video"&&`${c} ${m==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>X(e=>!e),children:n(Ne,{})})]})]})]})})}export{xe as default};
