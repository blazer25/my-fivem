import{u as L,r as S,j as m,m as Q,a as e,F as le,L as i,v as I,C as _,a0 as ze,a1 as _e,b as W,d as he,i as H,t as $,P as X,H as $e,N as Qe,a2 as me,a3 as Ve,S as xe,Q as Se,A as ae,I as Ke,g as de,a4 as Je,l as we,a5 as et,a6 as Fe,a7 as Me,a8 as Oe,a9 as Ye,aa as tt,K as pe,ab as ye,ac as Ae,w as Y,x as Ge,ad as De,ae as at,X as Ne,af as Re,q as ke,R as st,T as nt,ag as Ce,s as rt,ah as it,h as ne,ai as lt,B as ot,D as ct,aj as dt,ak as ut,z as mt,W as St,al as ht,f as ft}from"./index-569b241b.js";import{A as Et,g as gt}from"./audioRecorder-fa4154b8.js";import{g as vt,a as At,b as Pt,i as Mt,M as ge,A as Ue,c as pt,T as Nt,d as Ct,e as bt,L as Le,C as Tt,f as It}from"./Maps-e09ece0f.js";const He=t=>{if(t)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t)},Pe=t=>{if(t)return t==="<!CALL-NO-ANSWER!>"},wt=t=>{if(t)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(t)},Ot=t=>{if(t.length===0)return!0;if(t)return!/^<!.*!>$/.test(t)},yt=({onEnd:t,close:n})=>{const E=L(W),[A,C]=S.useState(!1),[p,o]=S.useState(0),[a,T]=S.useState(null),g=S.useRef(null);if(!E.EnableVoiceMessages)return null;S.useEffect(()=>{if(!A)return;let l=setInterval(()=>{o(c=>c+1)},1e3);return()=>clearInterval(l)},[A]),S.useEffect(()=>(g.current=new Et,()=>{g.current&&g.current.stop()}),[]);const O=l=>{let c=Math.floor(l/60),f=l%60;return`${c}:${f<10?"0":""}${f}`},s=async l=>{const c=await gt(new Blob(l),25,7,324,55,3);T(c)};return m(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"audioMessage-container",children:[e("div",{className:"close",onClick:n}),m("div",{className:"audioMessage-wrapper",children:[m("div",{className:"duration",children:[A&&e("div",{className:"dot"}),O(p)]}),e("div",{className:"content",children:A?e(le,{children:a!=null&&a.base64?e("img",{src:a==null?void 0:a.base64}):i("APPS.MESSAGES.LOADING")}):i("APPS.MESSAGES.START_RECORDING")}),e("div",{className:"button","data-recording":A,onClick:()=>{var c;if(!((c=navigator.mediaDevices)!=null&&c.getUserMedia)||!(g!=null&&g.current))return I("error","No media devices found!");let l=g.current;A?l.stop().then(f=>{if(!f){o(0),C(d=>!d),_.PopUp.set({title:i("APPS.MESSAGES.EMPTY_RECORDING.TITLE"),description:i("APPS.MESSAGES.EMPTY_RECORDING.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.EMPTY_RECORDING.OK")}]});return}t(f),C(d=>!d)}):(l.start(100,s),C(f=>!f))},children:A?e(ze,{}):e(_e,{})})]})]})},Gt=({paymentAmount:t,setPaymentAmount:n,close:E})=>{const{User:A}=S.useContext(oe),C=L(W),[p]=A,[o,a]=S.useState(0),[T,g]=S.useState(4);let O={0:3,11:2.75,14:2.2};return S.useEffect(()=>{o===0&&g(O[0]);let s=0;for(let l=0;l<Object.keys(O).length;l++)o>=parseInt(Object.keys(O)[l])&&(s=O[Object.keys(O)[l]]);g(s)},[o]),S.useEffect(()=>{n(o)},[o]),m(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"payment-container",children:[e("div",{className:"close",onClick:E}),m("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&a(s=>s-1),children:"-"}),e("div",{className:"amount",children:e(he,{type:"number",value:t,style:{fontSize:`${T}rem`},onChange:s=>{if(s.target.value.match(/^[0-9]+$/)&&parseFloat(s.target.value)>0&&parseFloat(s.target.value)<(C.MaxTransferAmount??Number.MAX_SAFE_INTEGER))a(parseFloat(s.target.value));else return s.preventDefault()}})}),e("div",{className:"button",onClick:()=>a(s=>s+1),children:"+"})]}),m("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>Dt(t,p.number),children:i("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>je(t,{id:p.id,name:p.name,number:p.number}),children:i("APPS.MESSAGES.PAY.SEND")})]})]})},je=(t,n)=>{var E;if(W.value.EnableMessagePay&&!(!t&&t<=0)){if(t>(((E=W.value)==null?void 0:E.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return I("error","Amount is too high");_.PopUp.set({title:i("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:W.value.CurrencyFormat.replace("%s",t.toString())}),description:i("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:W.value.CurrencyFormat.replace("%s",t.toString()),name:n.name??H(n.number)}),buttons:[{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{$("Wallet",{action:"sendPayment",number:n.number,amount:t},{success:!0}).then(A=>{var C,p;if(A.success){let o={id:n.id,sender:(p=(C=X)==null?void 0:C.PhoneNumber)==null?void 0:p.value,content:`<!SENT-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};R.set([...R.value,o])}else{I("error","Failed to send payment "+JSON.stringify(A)),setTimeout(()=>{_.PopUp.set({title:i(`APPS.WALLET.${A.reason}.TITLE`),description:i(`APPS.WALLET.${A.reason}.DESCRIPTION`),buttons:[{title:i("APPS.WALLET.OK")}]})},500);return}})}}]})}},Dt=(t,n)=>{var A,C;if(!W.value.EnableMessagePay||!t&&t<=0)return;let E={sender:(C=(A=X)==null?void 0:A.PhoneNumber)==null?void 0:C.value,content:`<!REQUESTED-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};$("Messages",{action:"sendMessage",number:n,content:E.content,attachments:[]},{messageId:Math.floor(Math.random()*1e3).toString()}).then(p=>{if(!p)return R.set([...R.value,{...E,delivered:!1}]);R.set([...R.value,{...E,id:p.messageId}])})},We={Messagelist:[{id:"1",number:"4802940940",name:"Loaf Scripts",unread:!0,lastMessage:"Sure Thing!",messages:[{sender:"4802940940",content:"Sure Thing!",timestamp:Date.now()-1e3*60*60*2},{sender:"1234567890",content:"Ready to release more products?",timestamp:Date.now()-1e3*60*60*2-1e3*60*5},{sender:"4802940940",content:"Hey!",timestamp:Date.now()-1e3*60*60*2-1e3*60*10}],timestamp:Date.now()-1e3*60*60*2},{id:"2",name:"Office Chat",unread:!0,lastMessage:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4,isGroup:!0,members:[{number:"4802940940",name:"Loaf Scripts",isOwner:!1},{number:"1566444151",name:"Peter",isOwner:!1},{number:"2051440412",name:"Peter",isOwner:!1},{number:"2051440412",isOwner:!1}],messages:[{sender:"4802940940",content:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4},{sender:"1566444151",content:"please confirm the time",timestamp:Date.now()-1e3*60*60*4-1e3*60*5},{sender:"2051440412",content:"Hey everyone, please make sure to be on time for the meeting",timestamp:Date.now()-1e3*60*60*4-1e3*60*10}]},{id:"3",number:"4802940963",unread:!1,lastMessage:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24,messages:[{sender:"4802940940",content:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24},{sender:"1234567890",content:"i hope you feel better soon",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*5},{sender:"4802940940",content:"still sick :(",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*10}]},{id:"4",number:"4802940942",unread:!0,lastMessage:"see you!",timestamp:Date.now()-1e3*60*60*2*24*2,messages:[{sender:"4802940942",content:"<!SENT-LOCATION-X=400.2Y=-1550.3!>",timestamp:Date.now()-1e3*60*60*2*24},{sender:"4802940942",content:`see you!

heres the location`,timestamp:Date.now()-1e3*60*60*2*24*2},{sender:"1234567890",content:"ofcourse, i will be there",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3},{sender:"4802940942",content:"hey buddy, still on for tomorrow?",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3}]}]};function Rt({location:t}){var l,c,f;const n=L(W),E=L(Ue),[A,C]=S.useState("losSantos"),p=vt(n==null?void 0:n.CustomMaps),o=At(n==null?void 0:n.CustomMaps),a=Pt(A,n==null?void 0:n.CustomMaps),T={minZoom:0,maxZoom:6},O=o.mapTypes[A]||T,s=()=>A===ge.LOS_SANTOS?Le:A===ge.CAYO_PERICO?Tt:n!=null&&n.CustomMaps&&n.CustomMaps.length>0&&n.CustomMaps.findIndex((G,V)=>`customMap${V}`===A)!==-1?It(A,n.CustomMaps):Le;return S.useEffect(()=>{n!=null&&n.CustomMaps&&n.CustomMaps.length>0?C("customMap0"):C(Mt({x:t[0],y:t[1]},n==null?void 0:n.CustomMaps)?ge.LOS_SANTOS:ge.CAYO_PERICO)},[t,n==null?void 0:n.CustomMaps]),S.useEffect(()=>{if(!(n!=null&&n.CustomMaps)||n.CustomMaps.length===0)return;const G=(()=>{var x;const V=n.CustomMaps.findIndex((k,D)=>`customMap${D}`===A);return V!==-1?((x=n.CustomMaps[V].styles)==null?void 0:x.map(D=>D.name))||["render","game","print"]:["render","game","print"]})();G.includes(E)||(Ue.set(G[0]),localStorage.setItem("lb-active-map-type",G[0]))},[A,n==null?void 0:n.CustomMaps,E]),S.useEffect(()=>{setTimeout(()=>{const d=document.querySelector(".leaflet-control-attribution.leaflet-control a");d&&(d.removeAttribute("href"),d.onclick=()=>{window.invokeNative("openUrl","https://leafletjs.com/")})},500)},[]),e("div",{className:"mapscomponent-wrapper",children:m(pt,{className:"map",crs:s(),style:{backgroundColor:((l=o.backgrounds)==null?void 0:l[E])||"#0d2b4f"},center:[t[0],t[1]],zoom:4,scrollWheelZoom:!1,zoomControl:!1,doubleClickZoom:!1,dragging:!1,bounceAtZoomLimits:!0,boxZoom:!1,maxBoundsViscosity:.95,maxBounds:a,attributionControl:!1,preferCanvas:!0,children:[e(Nt,{url:((f=(c=p[A])==null?void 0:c.tileServer)==null?void 0:f.replace("{layer}",E))||"",minZoom:O.minZoom,maxZoom:O.maxZoom,maxNativeZoom:O.maxZoom,noWrap:!0},`${A}-${E}`),e(Ct,{position:t,icon:bt()})]})})}const R=pe([]);function kt(){const{User:t,View:n,UnreadMessages:E}=S.useContext(oe),A=L(X.Settings),C=L(W),p=L(X.PhoneNumber),o=L(ae),[a,T]=t,[g,O]=n,[s,l]=E,c=L(R),f=L(_.Emoji),d=L(_.Gif),[G,V]=S.useState(!1),[x,k]=S.useState(null),[D,Z]=S.useState(!1),[U,se]=S.useState(!1),[z,P]=S.useState(0),[b,h]=S.useState(null),v=S.useRef(null),y=S.useRef(0),N=S.useRef(!1),[M,B]=S.useState({content:"",attachments:[]});if(!a)return null;S.useEffect(()=>{if(!$e("Messages"))return;const r=(u=void 0,w=0)=>{var ce;if(w>=10)return Promise.resolve();const q={action:"getMessages",id:a==null?void 0:a.id};return u!==void 0&&(q.lastId=u),$("Messages",q,((ce=We.Messagelist.find(j=>j.id===a.id))==null?void 0:ce.messages)??[]).then(j=>{if(!j||j.length===0)return;const re=j.filter(ee=>{const ve=Pe(ee.content),Ze=ee.sender===p;return!(ve&&Ze)}),Ie=R.value||[],Ee=[...re.reverse(),...Ie];if(R.set(Ee),J.current=Ee.length,re.length<10&&j.length>=25&&w<10-1){const ee=j[j.length-1],ve=ee!=null&&ee.id?typeof ee.id=="number"?ee.id:parseInt(ee.id):void 0;return r(ve,w+1)}})};r()},[o==null?void 0:o.active]);const be=()=>{if(M.content.length<=0&&M.attachments.length<=0&&!b)return I("info","Message is empty, returning");let r={sender:p,timestamp:Date.now(),id:a.id,content:M.content,attachments:M.attachments};if(!Ot(M.content))return I("error","Message contains invalid characters, returning",M.content);if(b){if(N.current)return;N.current=!0,ye("Image",b.waves.message).then(u=>{ye("Audio",b.blob).then(w=>{r.content=`<!AUDIO-MESSAGE-IMAGE="${u}"-AUDIO="${w}"-DURATION="${b.duration}"!>`,$("Messages",{action:"sendMessage",number:a.number,content:r.content,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(F=>{F&&Ae()?R.set([...R.value,{...r,id:F.messageId}]):R.set([...R.value,{...r,delivered:!1}]),N.current=!1,h(null)})}).catch(w=>{console.error("Failed to upload voice message audio",w),N.current=!1})}).catch(u=>{console.error("Failed to upload voice message image",u),N.current=!1});return}if(!Ae())return R.set([...R.value,{...r,delivered:!1}]);$("Messages",{action:"sendMessage",number:a.number,content:M.content,attachments:M.attachments,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(u=>{u?(R.set([...R.value,{...r,id:u.messageId}]),h(null)):R.set([...R.value,{...r,delivered:!1}]),B({content:"",attachments:[]}),v.current&&(v.current.value=""),I("info","Updating recent message cache state"),Y.APPS.MESSAGES.messages.set(Y.APPS.MESSAGES.messages.value.map(w=>w.id===a.id?{...w,timestamp:new Date().getTime(),lastMessage:r.content.length>0&&r.content,unread:!1,deleted:!1}:w))})},Te=()=>{_.PopUp.set({title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{$("Maps",{action:"getCurrentLocation"},{x:0,y:0}).then(r=>{if(!r)return;let u={id:a.id,sender:p,content:`<!SENT-LOCATION-X=${Ge(r.x,2)}Y=${Ge(r.y,2)}!>`,attachments:[],timestamp:Date.now()};$("Messages",{action:"sendMessage",number:a.number,content:u.content,attachments:u.attachments,id:u.id},{messageId:Math.random().toString(36).substring(7)}).then(w=>{if(!w)return R.set([...R.value,{...u,delivered:!1}]);R.set([...R.value,{...u,id:w.messageId}])})})}}]})},K=S.useRef(!1),J=S.useRef(0),fe=S.useRef(null),{handleScroll:Be}=Qe({fetchData:()=>{var r;return $("Messages",{action:"getMessages",id:a.id,lastId:(r=R.value[0])==null?void 0:r.id})},onDataFetched:r=>{if(!r||r.length===0){K.current=!1;return}const u=fe.current||document.querySelector(".message-container");if(u){y.current=u.scrollHeight;const ce=-u.scrollHeight+u.clientHeight+50,j=u.scrollTop<=ce;K.current=j}else K.current=!1;const w=R.value||[],q=[...r.reverse(),...w];R.set(q)},isReversed:!0,perPage:25});S.useLayoutEffect(()=>{const r=c.length>J.current;if(!K.current||!r){J.current=c.length;return}if(J.current===0){J.current=c.length,K.current=!1;return}if(r&&!K.current){J.current=c.length;return}const u=fe.current||document.querySelector(".message-container");if(!u){K.current=!1,J.current=c.length;return}const w=u.scrollTop,F=y.current;let q=0;const ce=5,j=()=>{const re=fe.current||document.querySelector(".message-container");if(!re||re!==u){K.current=!1,J.current=c.length;return}const ue=re.scrollHeight-F;if(ue===0&&q<ce){q++,requestAnimationFrame(j);return}if(ue>0&&ue<1e4){const Ee=w+ue;re.scrollTop=Ee}K.current=!1,J.current=c.length};j()},[c]),me("messages:newMessage",r=>{a.id===r.channelId&&R.set([...R.value,{...r,timestamp:Date.now()}])},{waitUntilService:!0}),me("messages:renameGroup",r=>{a.id===r.channelId&&T(u=>({...u,name:r.name}))},{waitUntilService:!0}),me("messages:messageDeleted",r=>{if(I("info","messages:messageDeleted triggered",r),!r)return I("error","Did not get any data from messages:messageDeleted, returning");R.set(R.value.filter(u=>u.id!==r.messageId))},{waitUntilService:!0}),me("messages:removeMember",r=>{a.id===r.channelId&&r.number===p&&(O("userlist"),T(null))},{waitUntilService:!0});const qe=Ve(r=>{if(!C.DeleteMessages)return I("error","Config.DeleteMessages is set to false");let u=r.target;for(;!u.classList.contains("message");)u=u.parentElement;let w=u.getAttribute("data-id");if(!w)return I("error","Failed to get message id when longpressing");isNaN(w)||(w=parseInt(w));let F=c.find(q=>q.id===w);if(!F)return I("error","Failed to find message with id",w);F.sender===p&&(He(F.content)||Xe(F.content)||Pe(F.content)||_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{$("Messages",{action:"deleteMessage",channel:a.id,id:w}).then(q=>{if(!q)return I("error","Failed to delete message")})}}]}))}),Xe=r=>!r||!C.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(r)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(r);return e(le,{children:m(Q.div,{...xe("right","message",.2),className:"animation-container",children:[m(Se,{children:[G&&e($t,{setShow:V,setShowUserInfo:k,sendLocation:Te,setData:T,data:a}),x&&e(_t,{setShow:k,user:a!=null&&a.isGroup?x:a})]}),m("div",{className:"message-header",children:[m("div",{className:"back",onClick:()=>{var r;O("userlist"),T(null),(r=ae.value.active)!=null&&r.data&&ae.patch({active:{name:"Messages",data:null}}),a.unread&&($("Messages",{action:"markRead",id:a.id}),l(u=>u-1))},children:[e(Ke,{}),s>0&&e("span",{className:"back-title",children:s})]}),m("div",{className:"user",onClick:()=>{a!=null&&a.isGroup?V(!0):k(!0)},children:[a!=null&&a.isGroup?e("div",{className:"group-avatar",style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:!(a!=null&&a.avatar)&&m(le,{children:[a.members.sort((r,u)=>r.name&&u.name?r.name.localeCompare(u.name):r.name?-1:u.name?1:0).sort((r,u)=>(r.avatar?1:-1)-(u.avatar?1:-1)).slice(0,5).map((r,u)=>e("div",{className:"avatar","data-hasavatar":(r==null?void 0:r.avatar)!==void 0,style:{backgroundImage:r!=null&&r.avatar?`url(${r.avatar})`:null,zIndex:a.members.length-u},children:r.name?!(r!=null&&r.avatar)&&de(r.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})},u)),a.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})]})}):e("div",{className:"avatar","data-hasavatar":(a==null?void 0:a.avatar)!==void 0,style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:a.name?!(a!=null&&a.avatar)&&de(a.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:a!=null&&a.isGroup?a.name??`${a.members.length===0?1:a.members.length} ${i("APPS.MESSAGES.PEOPLE")}`:a.name??H(a.number)})]}),m("div",{className:"buttons","data-hidden":a==null?void 0:a.isGroup,children:[e(Je,{onClick:()=>{a!=null&&a.isGroup||we({number:a.number})}}),e(et,{onClick:()=>{a!=null&&a.isGroup||we({number:a.number,videoCall:!0})}})]})]}),e("div",{ref:fe,className:"message-container",onScroll:Be,style:U||D?{height:"48%"}:{},children:e("div",{className:"message-body",children:(()=>{var r;return I("info","Render","Rendering messages",{messagesLength:c.length,messagesArray:c,MessagesValueLength:((r=R.value)==null?void 0:r.length)||0,firstMessage:c[0],lastMessage:c[c.length-1]}),c.map((u,w)=>{var F;return I("info","Render",`Rendering message ${w}`,{messageId:u.id,content:(F=u.content)==null?void 0:F.substring(0,50),sender:u.sender,timestamp:u.timestamp}),e(Ut,{index:w,messages:c,message:u,longPressEvent:qe},u.id||w)})})()})}),e("div",{className:"attachments",children:M.attachments.map((r,u)=>m("div",{className:"attachment",children:[Fe(r)?e("video",{src:r,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e(Me,{src:r,blur:!0}),e(Oe,{onClick:()=>{B({...M,attachments:M.attachments.filter((w,F)=>F!==u)})}})]},u))}),m("div",{className:"message-bottom","data-expanded":!!(U||D),children:[e("div",{className:"upper",children:m("div",{className:"input","data-border":!b,children:[b?m("div",{className:"audio-message",children:[e(Oe,{onClick:()=>h(null)}),e("div",{className:"audio-waves",children:e("img",{src:b.waves.placeholder})})]}):e(he,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),ref:v,value:M.content,onChange:r=>{B({content:r.target.value,attachments:M.attachments})},onKeyDown:r=>{r.key=="Enter"&&be()}}),(M.content.length>0||M.attachments.length>0||b)&&e("div",{className:"send",onClick:be,children:e(Ye,{})})]})}),!U&&!D&&e("div",{className:"actions-wrapper",children:m("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(f)return _.Emoji.reset();_.Emoji.set({onSelect:r=>B(u=>({content:`${u.content}${r.emoji}`,attachments:u.attachments}))})},children:"ðŸ˜€"}),e("div",{className:"action",onClick:()=>{var r,u,w;M.attachments.length<3&&_.Gallery.set({includeVideos:!0,allowExternal:(w=(u=(r=W)==null?void 0:r.value)==null?void 0:u.AllowExternal)==null?void 0:w.Messages,onSelect:F=>B({...M,attachments:[...M.attachments,F.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),C.EnableGIFs!==!1&&e("div",{className:"action small",onClick:()=>{if(d)return _.Gif.reset();_.Gif.set({onSelect:r=>B(u=>({content:u.content,attachments:[...u.attachments??[],r]}))})},children:"GIF"}),(C==null?void 0:C.EnableMessagePay)&&!(a!=null&&a.isGroup)&&e("div",{className:"action ",onClick:()=>{Z(!1),se(r=>!r)},children:"$"}),e("div",{className:"action",onClick:()=>Te(),children:e(tt,{})}),(C==null?void 0:C.EnableVoiceMessages)&&e("div",{className:"action",onClick:()=>{se(!1),Z(r=>!r)},children:e(_e,{})})]})}),e(Se,{children:U&&e(Gt,{paymentAmount:z,setPaymentAmount:P,close:()=>se(!1)})}),e(Se,{children:D&&e(yt,{onEnd:r=>{if(!r)return I("error","Failed to get audio message data");h({blob:r.blob,waves:r.waveform,duration:r.duration}),Z(!1)},close:()=>Z(!1)})})]})]})})}const Ut=({messages:t,message:n,index:E,longPressEvent:A})=>{var G,V,x;const{User:C}=S.useContext(oe),p=L(X.PhoneNumber),[o]=C,a=L(W);I("info","MessageComponent",`Rendering message component ${E}`,{messageId:n.id,content:(G=n.content)==null?void 0:G.substring(0,50),sender:n.sender,phoneNumber:p,index:E,totalMessages:t.length});let T,g,O,s,l,c,f=n.sender===p?"self":"other",d=((V=t[E+1])==null?void 0:V.sender)===p?"self":"other";if(t[E+1]?O=Math.abs(n.timestamp-t[E+1].timestamp)/36e5:d=void 0,o!=null&&o.isGroup)T=(x=o.members.find(k=>k.number===n.sender))==null?void 0:x.name,g=!t[E-1]||t[E-1].sender!==n.sender;else if(T=o.name,n.content)if(Pe(n.content))if(f==="other")n.content=i("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return I("info","MessageComponent",`Message ${E} returning null (missed call from self)`),null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?s={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(s={amount:n.content.match(/\d/g).join(""),request:!0});if(He(n.content)){let k=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],D=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];l={x:k,y:D}}return wt(n.content)&&(c={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),m("div",{className:`message ${f}`,"data-id":n.id,...A,children:[g&&f=="other"&&e("div",{className:"user",children:T??H(n.sender)}),n.delivered===!1?m("div",{className:"content-wrapper",children:[s&&e("div",{className:"payment",children:a.CurrencyFormat.replace("%s",s.amount)}),!s&&e("div",{className:"content",children:De(n.content)}),e(at,{})]}):s||l||c?m(le,{children:[l&&m("div",{className:"location",onClick:()=>{_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.OPEN_IN_MAPS"),cb:()=>{ae.patch({active:{name:"Maps",data:{location:[l.y,l.x],name:i("APPS.MESSAGES.USERS_LOCATION").format({name:T??H(n.sender)}),icon:o.avatar}}})}},{title:i("APPS.MAPS.SET_WAYPOINT"),cb:()=>{$("Maps",{action:"setWaypoint",data:{x:l.x,y:l.y}})}}]})},children:[e(Rt,{location:[parseFloat(l.y),parseFloat(l.x)]}),f==="other"&&m("div",{className:"sender",children:[T??H(n.sender)," ",i("APPS.MESSAGES.SENT_LOCATION")]})]}),s&&e("div",{className:"payment",children:s.request?m("div",{className:Ne("request",f),children:[m("div",{className:"title",children:[a.CurrencyFormat.replace("%s",Re(s.amount).toString())," ",i("APPS.MESSAGES.PAY.REQUESTED")]}),f==="other"&&e("div",{className:"button",onClick:()=>je(s.amount,{id:o.id,number:o.number,name:o.name}),children:i("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:a.CurrencyFormat.replace("%s",Re(s.amount).toString())})}),c&&e(Lt,{data:c,sender:f})]}):n.content&&e("div",{className:"content",children:De(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((k,D)=>Fe(k)?e("video",{src:k,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:Z=>_.FullscreenImage.set(k)},D):e(Me,{src:k,blur:!0,onClick:()=>_.FullscreenImage.set(k)},D))}),n.delivered===!1?e("div",{className:"status",children:i("APPS.MESSAGES.NOT_DELIVERED")}):t[E+1]&&O>6?e("div",{className:"date",children:ke(n.timestamp)}):f!==d&&e("div",{className:"date",children:ke(n.timestamp)})]},E)},Lt=({data:t,sender:n})=>{var T;const[E,A]=S.useState(!1),[C,p]=S.useState(0),o=S.useRef(null);S.useEffect(()=>{o.current&&(o.current.onended=()=>A(!1))},[o]);const a=g=>{g=Math.floor(g);const O=Math.floor(g/60),s=g-O*60;return`${O<10?"0"+O:O}:${s<10?"0"+s:s}`};return m("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{o.current&&(E?(o.current.pause(),o.current.currentTime=0):o.current.play().catch(()=>I("error","Failed to play audio message")),A(g=>!g))},children:E?e(st,{}):e(nt,{})}),m("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-C)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:a(E&&Math.floor(((T=o.current)==null?void 0:T.currentTime)+.5)!==0?o.current.currentTime:t.duration)}),e("audio",{ref:o,onTimeUpdate:g=>p(g.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},_t=({user:t,setShow:n})=>{const E=L(X.Settings);return m(Q.div,{...Ce,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:i("APPS.MESSAGES.DONE")})}),m("div",{className:"info-panel-body",children:[m("div",{className:"info-panel-top",children:[e("div",{className:"avatar","data-hasavatar":(t==null?void 0:t.avatar)!==void 0,style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&de(t.name):e("img",{src:`./assets/img/avatar-placeholder-${E.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:t.name??H(t.number)})]}),e("div",{className:"items",children:!t.company&&m(le,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>rt(t.number),children:H(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{_.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:i("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{ae.patch({active:{name:"Phone",data:{view:"newContact",number:t.number}}})},children:i("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]})},$t=t=>{const{View:n}=S.useContext(oe),E=L(X.Settings),[A,C]=n,[p,o]=S.useState(t.data.name),[a,T]=S.useState(t.data.avatar);let g=t.data,O=!g.members.find(s=>s.isOwner);return e(le,{children:m(Q.div,{...Ce,className:"info-panel",children:[m("div",{className:"info-panel-header",children:[e("div",{}),e("div",{className:"close",children:e("div",{className:"button",onClick:()=>t.setShow(!1)})}),e("div",{className:"done",onClick:()=>{p&&p!==""&&p!==g.name?$("Messages",{action:"renameGroup",id:g.id,name:p}).then(s=>{t.setShow(!1)}):t.setShow(!1)},children:i("APPS.MESSAGES.DONE")})]}),m("div",{className:"info-panel-body",children:[m("div",{className:"info-panel-top",children:[a?e(Me,{className:"group-image",src:a,blur:!0}):m("div",{className:"group-avatar",children:[g.members.sort((s,l)=>s.avatar?1:-1).slice(0,5).map((s,l)=>e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null,zIndex:g.members.length-l},children:s.name?!(s!=null&&s.avatar)&&de(s.name):e("img",{src:`./assets/img/avatar-placeholder-${E.display.theme}.svg`,alt:""})},l)),g.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${E.display.theme}.svg`,alt:""})]}),e("div",{className:"add-photo",onClick:()=>{var s,l,c;a?_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.REMOVE"),color:"red",cb:()=>{$("Messages",{action:"removeGroupAvatar",id:g.id},!0).then(f=>{if(!f)return I("warning","Could not remove group avatar");t.setData(d=>{let G=d;return G.avatar=null,G}),T(null)})}}]}):_.Gallery.set({allowExternal:(c=(l=(s=W)==null?void 0:s.value)==null?void 0:l.AllowExternal)==null?void 0:c.Messages,onSelect:f=>$("Messages",{action:"setGroupAvatar",id:g.id,avatar:f.src},!0).then(d=>{if(!d)return I("warning","Could not set group avatar");t.setData(G=>{let V=G;return V.avatar=f.src,V}),T(f.src)})})},children:a?"Remove Photo":" Add Photo"})]}),m("div",{className:"items",children:[e("div",{className:"info-section",children:m("div",{className:"item blue",children:[e(it,{className:"add"}),e(he,{defaultValue:g.name??i("APPS.MESSAGES.GROUP_NAME"),onChange:s=>o(s.target.value)})]})}),m("div",{className:"subtitle",children:[g.members.length===0?1:g.members.length," ",i("APPS.MESSAGES.MEMBERS")]}),m("div",{className:"info-section",children:[m("div",{className:"item",onClick:()=>_.ContactSelector.set({filter:g.members.map(s=>s.number),onSelect:s=>{if(g.members.find(l=>l.number===s.number))return I("info","User is already in group");$("Messages",{action:"addMember",id:g.id,number:s.number},!0).then(l=>{if(!l)return I("warning","Could not add member to group");t.setData(c=>{let f=c;return f.members.push({...s,name:ne(s.firstname,s.lastname),isOwner:!1}),f})})}}),children:[e(lt,{className:"add"}),e("div",{className:"name",children:i("APPS.MESSAGES.ADD_MEMBER")})]}),g.members.sort((s,l)=>s.name&&!l.name?-1:!s.name&&l.name?1:s.name<l.name?-1:s.name>l.name?1:0).map((s,l)=>m("div",{className:"item",children:[O&&e(ot,{className:"remove",onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:s.name??H(s.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{$("Messages",{action:"removeMember",number:s.number,id:g.id}).then(c=>{c&&(t.setData(f=>{let d=f;return d.members=d.members.filter(G=>G.number!==s.number),d}),t.setShow(!1))})}}]})}}),e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null},children:s.name?!(s!=null&&s.avatar)&&de(s.name):e("img",{src:`./assets/img/avatar-placeholder-${E.display.theme}.svg`,alt:""})}),m("div",{className:"details",children:[e("div",{className:"name",children:s.name??H(s.number)}),s.name&&e("div",{className:"phone-number",children:H(s.number)})]}),e(ct,{className:"info",onClick:()=>t.setShowUserInfo({...s})})]},l))]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:i("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:i("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{$("Messages",{action:"leaveGroup",id:g.id}).then(s=>{if(!s)return I("info","Failed to leave group, server didnt callback request");C("userlist"),t.setShow(!1)})}}]})},children:m("div",{className:"item red",children:[e(dt,{}),i("APPS.MESSAGES.LEAVE_GROUP")]})})]})]})]})})};function Vt(){const{User:t,View:n,Newmessage:E,ImportedUser:A}=S.useContext(oe),[C,p]=t,[o,a]=n,[T,g]=A,O=L(X.Settings),s=L(X.PhoneNumber),[l,c]=E,f=L(Y.APPS.PHONE.contacts),[d,G]=S.useState([]),V=S.useRef(null),[x,k]=S.useState(""),[D,Z]=S.useState([]),[U,se]=S.useState({content:"",attachments:[]});S.useEffect(()=>{T&&(G([T]),g(null))},[T]);const z=()=>{(U.content.length>0||U.attachments.length>0)&&(d.length>1?$("Messages",{action:"createGroup",members:d,content:U.content,attachments:U.attachments}).then(P=>{if(!P)return I("error","Failed to create group");p({id:P.channelId,lastMessage:U.content,timestamp:Date.now(),isGroup:!0,members:d.map(b=>{let h=ne(b.firstname,b.lastname);return{...b,name:h}})}),a("messages"),c(!1)}):($("Messages",{action:"sendMessage",number:d[0].number,content:U.content,attachments:U.attachments}).then(P=>{var v,y,N,M;if(!P)return I("error","Failed to send message");let b;d[0].name?b=d[0].name:(v=d[0])!=null&&v.firstname&&(b=ne((y=d[0])==null?void 0:y.firstname,(N=d[0])==null?void 0:N.lastname));let h={number:d[0].number,name:b,avatar:(M=d[0])==null?void 0:M.avatar};p({...h,id:P.channelId,lastMessage:U.content,timestamp:Date.now()}),I("info","Updating recent message cache state"),Y.APPS.MESSAGES.messages.set(Y.APPS.MESSAGES.messages.value.map(B=>B.id===P.channelId?{...B,timestamp:new Date().getTime(),lastMessage:U.content,unread:!1,deleted:!1}:B))}),a("messages"),c(!1)))};return S.useEffect(()=>{if(x.length>0){if(!f)return I("error","Contacts not loaded");Z(f.filter(P=>{let b=ne(P.firstname,P.lastname);return b&&(b==null?void 0:b.toLowerCase().includes(x==null?void 0:x.toLowerCase()))&&!P.company}))}else Z([])},[x]),m(Q.div,{...Ce,className:"new-message-container",children:[m("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:i("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{var b,h,v;d.length>0&&(U.content.length>0||U.attachments.length>0)?z():(c(!1),(v=(h=(b=ae)==null?void 0:b.value)==null?void 0:h.active)!=null&&v.data&&ae.patch({active:{...ae.value.active,data:null}}))},children:d.length>0&&(U.content.length>0||U.attachments.length>0)?i("APPS.MESSAGES.SEND"):i("APPS.MESSAGES.CANCEL")})]}),m("div",{className:"new-message-body",children:[m("div",{className:"new-message-search",children:[m("div",{className:"to",children:[i("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:d.map((P,b)=>{let h=ne(P.firstname,P.lastname),v=h!=="Unknown";return e("div",{className:Ne("contact",v?"green":"blue"),onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:h??H(P.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let y=d.filter(N=>N.number!==P.number);G(y)}}]})},children:v?h:H(P.number)},b)})}),e(he,{type:"text",ref:V,onChange:P=>{if(k(P.target.value),P.target.value.length==s.length&&/^\d+$/g.test(P.target.value)){if(P.target.value===s||d.find(h=>h.number==P.target.value))return;G([...d,{number:P.target.value}]),V.current.value="",k("")}},onKeyDown:P=>{var b;P.key=="Backspace"&&x.length==0?((b=d[d.length-1])==null?void 0:b.name)===void 0?(V.current.value=d[d.length-1].number,G(d.slice(0,d.length-1))):G(d.slice(0,-1)):P.key=="Tab"&&(P.preventDefault(),D.length==1&&(G([...d,D[0]]),V.current.value="",k("")))}})]}),e("div",{className:"search-results",children:D&&D.filter(P=>!d.find(b=>b.number==P.number)).map((P,b)=>{let h=ne(P.firstname,P.lastname);return m("div",{className:"contact",onClick:()=>{d.find(y=>y.number==P.number)||(G([...d,P]),V.current.value="",k(""))},children:[e("img",{src:P.avatar??`./assets/img/avatar-placeholder-${O.display.theme}.svg`}),m("div",{className:"user",children:[e("div",{className:"name",children:h}),e("div",{className:"number",children:H(P.number)})]})]},b)})})]}),d.length>0&&D.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:m("div",{className:"input",children:[e(he,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),value:U.content,onChange:P=>{se({content:P.target.value??"",attachments:U.attachments})},onKeyDown:P=>{P.key=="Enter"&&z()}}),(U.content.length>0||U.attachments.length>0)&&e("div",{className:"send",onClick:()=>z(),children:e(Ye,{})})]})})})]})}const te=pe([]),ie=pe([]);function xt(){var b;const{User:t,View:n,Newmessage:E,UnreadMessages:A,ImportedUser:C}=S.useContext(oe),p=L(X.PhoneNumber),o=(b=L(ae))==null?void 0:b.active,[a,T]=t,[g,O]=n,[s,l]=C,[c,f]=E,[d,G]=A,V=L(Y.APPS.PHONE.contacts),x=L(Y.APPS.MESSAGES.messages),k=L(te),[D,Z]=S.useState(""),[U,se]=S.useState(!1),z=L(ie);S.useEffect(()=>{if($e("Messages"))if(x)I("info","Using cache for recent messages"),G(k.filter(h=>h.unread).length),te.set(x.map(h=>{if(!h.name){let v=V.find(y=>y.number===h.number);if(!v)return h;h.name=ne(v.firstname,v.lastname),h.avatar=v==null?void 0:v.avatar}return h})??[]);else{if(!Ae())return I("info","No service, not fetching recent messages");$("Messages",{action:"getRecentMessages"},We.Messagelist).then(h=>{if(!h)return I("error","No recent messages");let v=h.map(y=>{if(y.isGroup)return y.members=y.members.filter(N=>N.number!==p).map(N=>{let M=V.find(B=>B.number===N.number);return{name:M&&M.firstname?ne(M==null?void 0:M.firstname,M==null?void 0:M.lastname):void 0,avatar:M==null?void 0:M.avatar,blocked:M==null?void 0:M.blocked,favourite:M==null?void 0:M.favourite,number:N.number,isOwner:N.isOwner}}),y;{let N=V.find(M=>M.number===y.number);return y.name=N!=null&&N.lastname?`${N.firstname} ${N.lastname}`:N==null?void 0:N.firstname,y.avatar=N==null?void 0:N.avatar,y}});G(v.filter(y=>y.unread).length),te.set(v),I("info","setting cache"),Y.APPS.MESSAGES.messages.set(v)})}},[x,o]);let P=S.useRef(!1);return S.useEffect(()=>{var h;if(!P.current&&o!=null&&o.data&&(P.current=!0,o!=null&&o.data&&((h=o.data)==null?void 0:h.view)=="messages")){let v=k==null?void 0:k.find(y=>y.number===o.data.number);v?(T(v),O("messages")):(f(!0),l({number:o.data.number,name:o.data.name,avatar:o.data.avatar}))}},[o==null?void 0:o.data,k]),me("messages:newMessage",h=>{let v=JSON.parse(JSON.stringify(te.value)),y=v.findIndex(N=>N.id===h.channelId);if(y!==-1&&v.unshift(v.splice(y,1)[0]),v.length===0)return I("error","No recent messages");v[0].lastMessage=h.content,v[0].timestamp=new Date,te.set(v)},{waitUntilService:!0}),m(le,{children:[e(Se,{children:c&&e(Vt,{})}),m(Q.div,{...xe("left","messagelist",.2),className:"animation-container",children:[m("div",{className:"messages-header",children:[m("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>se(!U),children:U?i("APPS.MESSAGES.DONE"):i("APPS.MESSAGES.EDIT")}),e(ut,{"data-disabled":U,onClick:()=>f(!0)})]}),e("div",{className:"title",children:i("APPS.MESSAGES.TITLE")})]}),e(mt,{placeholder:i("SEARCH"),onChange:h=>Z(h.target.value)}),e("div",{className:"users-list",children:k.filter(h=>{var v,y;return h.deleted?!1:(h.isGroup?h.members.find(N=>{var M;return N&&(((M=N.name)==null?void 0:M.toLowerCase().includes(D==null?void 0:D.toLowerCase()))||N.number.includes(D))}):((v=h.name)==null?void 0:v.toLowerCase().includes(D==null?void 0:D.toLowerCase()))||h.number.includes(D))||((y=h==null?void 0:h.lastMessage)==null?void 0:y.toLowerCase().includes(D==null?void 0:D.toLowerCase()))}).sort((h,v)=>v.timestamp-h.timestamp).map((h,v)=>e(Ft,{user:h,editMode:U,onClick:()=>{if(T(h),O("messages"),h.unread){$("Messages",{action:"markRead",id:h.id},!0),G(N=>N-1);let y=Y.APPS.MESSAGES.messages.value;Y.APPS.MESSAGES.messages.set(y.map(N=>(N.id===h.id&&(N.unread=!1),N)))}}},v))}),e(Se,{children:U&&m(Q.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},transition:{duration:.2,ease:"easeInOut"},className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:i("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(z.length===0)return I("info","No messages selected, can't delete");_.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{$("Messages",{action:"deleteConversations",channels:z},!0).then(h=>{if(!h)return I("error","Failed to delete conversations");se(!1),te.set(k.filter(v=>!z.includes(v.id))),Y.APPS.MESSAGES.messages.set([...Y.APPS.MESSAGES.messages.value.map(v=>(z.includes(v.id)&&(v.deleted=!0),v))]),ie.set([])})}}]})},children:i("APPS.MESSAGES.DELETE")})]})})]})]})}const Ft=({user:t,editMode:n,onClick:E})=>{var O,s;const A=L(W),C=L(X.Settings),p=L(te),[o,a]=S.useState(!1);let T;const g=Ve(l=>{_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{$("Messages",{action:"markRead",id:t.id},!0).then(c=>{if(!c)return I("error","Failed to mark message as read");te.set(p.map(d=>(d.id===t.id&&(d.unread=!1),d)));let f=Y.APPS.MESSAGES.messages.value;Y.APPS.MESSAGES.messages.set(f.map(d=>(d.id===t.id&&(d.unread=!1),d)))})}},{title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{_.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{$("Messages",{action:"deleteConversations",channels:[t.id]},!0).then(c=>{if(!c)return I("error","Failed to delete conversations");te.set(p.filter(f=>f.id!==t.id)),Y.APPS.MESSAGES.messages.set([...Y.APPS.MESSAGES.messages.value.map(f=>(f.id===t.id&&(f.deleted=!0),f))]),ie.set([])})}}]})}}]})});if(t.isGroup)if(t.name)T=t.name;else if(t.members.length===0)T=i("APPS.MESSAGES.GROUP");else{let l=t.members.length-1;T=t.members.sort((c,f)=>c.name&&!f.name?-1:!c.name&&f.name?1:c.name<f.name?-1:c.name>f.name?1:0).slice(0,2).map((c,f)=>{var G;let d=c.name?c.name:H(c.number);return f===1&&l>2?`${d} +${l} ${(G=i("APPS.MESSAGES.OTHER"))==null?void 0:G.toLowerCase()}`:d}).join(", ")}else T=t.name;if(t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=i("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.SENT")} ${A.CurrencyFormat.replace("%s",l)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.REQUESTED")} $${l}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${i("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=i("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=i("APPS.MESSAGES.TRIED_TO_CALL").format({number:H(t.number)});else if(t.lastMessage==="")return}return S.useEffect(()=>{o?ie.set([...ie.value,t.id]):ie.set(ie.value.filter(l=>l!==t.id))},[o]),m(Q.div,{initial:{opacity:0,scale:.9},whileInView:{opacity:1,scale:1},viewport:{once:!0},className:"user",...g,onClick:()=>{n?a(!o):E()},children:[m("div",{className:"items",children:[n&&e(Q.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"check","data-checked":o,onClick:l=>{l.stopPropagation(),a(!o)},children:o&&e(St,{})},"check"),e("div",{className:Ne("dot",t.unread&&"unread")})]}),t.isGroup?m("div",{className:"avatar group",children:[t.members.map((l,c)=>{var f;if(c<=3)return l.avatar?e("div",{"data-hasavatar":"true",style:{backgroundImage:`url(${l.avatar})`}},c):l.name?e("div",{children:(f=l==null?void 0:l.name)==null?void 0:f.charAt(0)},c):e("div",{className:"unknown"},c)}),t.members.length===0&&e("img",{className:"avatar",src:`assets/img/avatar-placeholder-${C.display.theme}.svg`})]}):e("div",{className:"avatar",style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&de(t.name):e("img",{src:`assets/img/avatar-placeholder-${C.display.theme}.svg`,alt:""})}),m("div",{className:"user-body",children:[m("div",{className:"user-header",children:[e("div",{className:"name",children:T??H(t.number)}),m("div",{className:"right",children:[e("div",{className:"time",children:ht(t.timestamp)}),e(ft,{})]})]}),e("div",{className:"content",children:((O=t.lastMessage)==null?void 0:O.length)>40?((s=t.lastMessage)==null?void 0:s.substring(0,40))+"...":t.lastMessage})]})]})};const oe=S.createContext(null);function Wt(){const[t,n]=S.useState(null),[E,A]=S.useState("userlist"),[C,p]=S.useState(null),[o,a]=S.useState(0),[T,g]=S.useState(!1);return e("div",{className:"messages-container","data-view":E,children:e(oe.Provider,{value:{User:[t,n],View:[E,A],Newmessage:[T,g],ImportedUser:[C,p],UnreadMessages:[o,a]},children:E==="userlist"?e(xt,{}):t&&e(kt,{})})})}export{oe as MessagesContext,Wt as default};
