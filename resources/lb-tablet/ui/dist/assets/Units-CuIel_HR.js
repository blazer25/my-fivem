import{u as D,r as f,k as v,bw as k,J as l,ah as F,h as M,n as p,a as c,o as T,j as r,L as a,g as G,aZ as H,K as J,bu as q,bs as V,O as w,i as x,ay as Z,bD as Q,a1 as X}from"./index-BbvBBay_.js";const d=w([]),o=w([]),A=w(!1);function K(){var S;const s=D(X.APPS.AMBULANCE.permissions),b=D(d),C=D(o),[n,m]=f.useState(null),[I,g]=f.useState({x:0,y:0}),h=f.useRef(null);let O=f.useMemo(()=>C.filter(e=>!e.unit),[C]);f.useEffect(()=>{const e=u=>{if(!A.value||!h.current)return;const P=h.current.getBoundingClientRect();g({x:u.clientX-P.width/2,y:u.clientY-P.height/2})},t=()=>{A.value&&(A.set(!1),m(null))};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[]),f.useEffect(()=>{v("Ambulance",{action:"getUnits"},k.units).then(e=>{var t,u;if(!e)return l("error","Failed to get units");d.set([...F()?((u=(t=M.value)==null?void 0:t.Ambulance)==null?void 0:u.DefaultUnits)??[]:[],...e??[]])}),v("Ambulance",{action:"getActiveUnits"},k.activeUnits).then(e=>{if(!e)return l("error","Failed to get active units");o.set(e)})},[]),p("addUnit",e=>{if(!e)return l("error","Failed to add unit");e.job==="ambulance"&&d.set([...d.value,e])}),p("updateUnit",e=>{if(!e)return l("error","Failed to add unit");e.job==="ambulance"&&(d.set(d.value.map(t=>t.name===e.unit?{...t,status:e.status??t.status,name:e.newName??t.name}:t)),e.newName&&o.set(o.value.map(t=>t.unit===e.unit?{...t,unit:e.newName??null}:t)))}),p("removeUnit",e=>{if(!e)return l("error","Failed to remove unit");e.job==="ambulance"&&(d.set(d.value.filter(t=>t.name!==e.unit)),o.set(o.value.map(t=>t.unit===e.unit?{...t,unit:null}:t)))}),p("setUserUnit",e=>{if(!e)return l("error","Failed to add user to unit");e.job==="ambulance"&&o.set(o.value.map(t=>t.source===e.source?{...t,unit:e.unit}:t))});const R=()=>{let e="";x.PopUp.set({title:a("APPS.POLICE.UNITS.ADD_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.ADD_UNIT.DESCRIPTION"),input:{placeholder:a("APPS.POLICE.UNITS.ADD_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:t=>{e=t}},buttons:[{title:a("APPS.POLICE.CANCEL"),cb:()=>{}},{title:a("APPS.POLICE.PROCEED"),cb:()=>{if(!e)return l("error","Unit name is required");if(d.value.some(t=>t.name===e))return l("error","Unit name already exists");v("Ambulance",{action:"addUnit",name:e},!0).then(t=>{if(!t)return l("error","Failed to add unit");l("info","Unit added"),F()&&d.set([...d.value,{name:e,status:"available"}])})}}]})},U=(e,t)=>{var u;if(!((u=s==null?void 0:s.unit)!=null&&u.edit))return l("error","You do not have permission to edit units");A.set(!0),m(e),g({x:t.clientX-50,y:t.clientY-25})},L=(e,t)=>{if(!n)return l("error","No employee to drag");if(t){if(o.value.some(u=>u.source===n.source&&u.unit===t))return m(null);v("Ambulance",{action:"assignOfficerToUnit",officerId:n.source,unit:t},!0).then(u=>{if(!u)return l("error","Failed to assign officer to unit");o.set(o.value.map(P=>P.source===n.source?{...P,unit:t}:P))})}else v("Ambulance",{action:"removeOfficerFromUnit",officerId:n.source},!0).then(u=>{if(!u)return l("error","Failed to remove officer from unit");o.set(o.value.map(P=>P.source===n.source?{...P,unit:null}:P))});A.set(!1),m(null)};return c(T.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{ease:"easeInOut",duration:.25},className:"policepage-container",children:[r("main",{className:"main",style:{padding:"0"},children:c("div",{className:"page",style:{gap:"0"},children:[c("div",{className:"top",children:[r("div",{className:"title",children:a("APPS.POLICE.UNITS.TITLE")}),((S=s==null?void 0:s.unit)==null?void 0:S.create)&&c("div",{className:"button",onClick:R,children:[r(G,{}),a("APPS.POLICE.UNITS.ADD_UNIT.TITLE")]})]}),c("div",{className:"units-container",children:[b.length===0?r("div",{className:"no-units",children:a("APPS.POLICE.UNITS.NO_UNITS")}):r("div",{className:"grid",children:b.map(e=>r(W,{unit:e,handleDragStart:U,handleDragEnd:L,draggedEmployee:n},e.name))}),c(T.div,{className:"grid-item full",onMouseUp:e=>{n&&L()},children:[r("div",{className:"top",children:c("div",{className:"title",children:[a("APPS.AMBULANCE.UNITS.AVALIABLE_EMPLOYEES"),c("div",{className:"subtitle",children:[r(H,{}),O.length]})]})}),r(J,{placeholder:a("APPS.AMBULANCE.UNITS.SEARCH_EMPLOYEES")}),c("div",{className:"items full",children:[O.map((e,t)=>c(T.div,{...q,className:V("item unit",(n==null?void 0:n.source)===e.source&&"dragging"),onMouseDown:u=>U(e,u),style:{cursor:"grab"},children:[e.callsign&&r("div",{className:"card green tabular",children:e.callsign}),r("div",{className:"name",children:e.name})]},t)),n&&r("div",{className:"drop-indicator",children:a("APPS.AMBULANCE.UNITS.DROP_EMPLOYEE_AVAILABLE")})]})]})]})]})}),A.value&&n&&r("div",{ref:h,className:"dragging-card",style:{position:"fixed",left:I.x,top:I.y},children:c("div",{className:"item unit",children:[n.callsign&&r("div",{className:"card green tabular",children:n.callsign}),r("div",{className:"name",children:n.name})]})})]})}const W=({unit:s,handleDragStart:b,handleDragEnd:C,draggedEmployee:n})=>{var U,L,S,e,t,u,P,B;const m=D(X.APPS.AMBULANCE.permissions),I=f.useMemo(()=>o.value.filter(i=>i.unit===s.name),[o.value,s.name]);let g=Z(()=>{var i;if(!A.value){if(!((i=m==null?void 0:m.unit)!=null&&i.edit))return l("error","You do not have permission to edit units");O()}}),h=(e=(S=(L=(U=M.value)==null?void 0:U.Ambulance)==null?void 0:L.UnitStatuses)==null?void 0:S[s==null?void 0:s.status])==null?void 0:e.color;const O=()=>{x.ContextMenu.set({buttons:[{title:a("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),cb:()=>{let i="";x.PopUp.set({title:a("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.RENAME_UNIT.DESCRIPTION"),input:{placeholder:a("APPS.POLICE.UNITS.RENAME_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:E=>{i=E}},buttons:[{title:a("APPS.POLICE.CANCEL"),cb:()=>{}},{title:a("APPS.POLICE.PROCEED"),cb:()=>{if(!i)return l("error","Unit name is required");v("Ambulance",{action:"renameUnit",unit:s.name,name:i},!0).then(E=>{if(!E)return l("error","Failed to edit unit name")})}}]})}},{title:a("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),color:"red",cb:()=>R()}]})},R=()=>{var i;if(!((i=m==null?void 0:m.unit)!=null&&i.delete))return l("error","You do not have permission to delete units");x.PopUp.set({title:a("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),description:a("APPS.POLICE.UNITS.DELETE_UNIT.DESCRIPTION"),buttons:[{title:a("APPS.POLICE.CANCEL")},{title:a("APPS.POLICE.DELETE"),color:"red",cb:()=>{v("Ambulance",{action:"deleteUnit",unit:s.name},!0).then(E=>{if(!E)return l("error","Failed to delete unit");l("info","Unit deleted"),F()&&(d.set(d.value.filter(N=>N.name!==s.name)),o.set(o.value.map(N=>N.unit===s.name?{...N,unit:null}:N)))})}}]})};return c(T.div,{...g,className:"grid-item",onMouseUp:i=>{n&&C(n,s.name)},children:[c("div",{className:"top",children:[c("div",{className:"title",children:[s.name,c("div",{className:"subtitle",children:[r(H,{}),I.length]})]}),c("div",{className:"buttons",style:{pointerEvents:"auto"},children:[r(Q,{showTitle:!0,disabled:!((t=m==null?void 0:m.unit)!=null&&t.edit),items:(B=Object.keys(((P=(u=M.value)==null?void 0:u.Ambulance)==null?void 0:P.UnitStatuses)??{}))==null?void 0:B.map(i=>{var N,Y,j;const E=(j=(Y=(N=M.value)==null?void 0:N.Ambulance)==null?void 0:Y.UnitStatuses)==null?void 0:j[i];return{title:E==null?void 0:E.label,active:i===s.status,onSelect:()=>{v("Ambulance",{action:"updateUnitStatus",unit:s.name,status:i},!0).then(z=>{if(!z)return l("error","Failed to update unit status");d.set(d.value.map(_=>_.name===s.name?{..._,status:i}:_))})}}})}),r("div",{className:"status","data-color":h})]})]}),c("div",{className:"items",children:[I.map((i,E)=>c(T.div,{...q,className:V("item unit",(n==null?void 0:n.source)===i.source&&"dragging"),onMouseDown:N=>b(i,N),style:{cursor:"grab"},children:[i.callsign&&r("div",{className:"card green tabular",children:i.callsign}),r("div",{className:"name",children:i.name})]},E)),n&&r("div",{className:"drop-indicator",children:a("APPS.AMBULANCE.UNITS.DROP_EMPLOYEE")})]})]})};export{K as default};
